

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Branch Classifier &mdash; Neurotrack 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=d45e8c67"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tracking Inference" href="sac_tracking_inference.html" />
    <link rel="prev" title="Make Simulated Neurons" href="make_simulated_neurons.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Neurotrack
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="make_simulated_neurons.html">Make Simulated Neurons</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Branch Classifier</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Collect-branch-classifier-training-data">Collect branch classifier training data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Get-sample-points-from-swc-files-then-save-sample-spherical-patches">Get sample points from swc files then save sample spherical patches</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Test-branch-extraction-methods">Test branch extraction methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Acquire-large-square-patches-for-on-the-fly-patch-extraction">Acquire large square patches for on-the-fly patch extraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Test-spherical-patch-extraction">Test spherical patch extraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Collect-branch-patch-data">Collect branch patch data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save-coordinates-and-annotations">save coordinates and annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save-square-patches">save square patches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save-spherical-patches">save spherical patches</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#View-some-example-input-images">View some example input images</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Train-branch-classifier">Train branch classifier</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Instantiate-dataloader-for-training-and-test-datasets">Instantiate dataloader for training and test datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Save-sample-patches-and-labels-from-image-files">Save sample patches and labels from image files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">View some example input images</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Train branch classifier</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Instantiate dataloader for training and test datasets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#View-balanced-data">View balanced data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sac_tracking_inference.html">Tracking Inference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Neurotrack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Branch Classifier</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/branch_classifier.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Branch-Classifier">
<h1>Branch Classifier<a class="headerlink" href="#Branch-Classifier" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cProfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pstats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_prep</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_prep.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">branch_classifier</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">models</span>
<span class="n">DATE</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2">-%y&quot;</span><span class="p">)</span>
<span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seeds</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/nafs/dtward/bryson/data/simulated_neurons/neuromorpho_with_artifacts/8-STRESS_2w_Female_HIP_7&#39;</span><span class="p">,</span> <span class="s1">&#39;*seeds.txt&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Load seeds from text file into a list of integers</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">seed_list</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seed_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> seeds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seed_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded 1 seeds
[[18, 248, 343]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="n">section_graph</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/nafs/dtward/bryson/data/simulated_neurons/neuromorpho_with_artifacts/8-STRESS_2w_Female_HIP_7&#39;</span><span class="p">,</span> <span class="s1">&#39;*section_graph.json&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">section_graph</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">section_graph</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># Convert all keys from string to int</span>
    <span class="n">section_graph</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">section_graph</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">section_graph</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;2&#39;: [3, 5, 10, 26, 35, 12, 68, 37, 51],
 &#39;3&#39;: [2, 5, 10, 26, 35, 12, 68, 37, 51],
 &#39;5&#39;: [2, 3, 10, 26, 35, 12, 68, 37, 51],
 &#39;10&#39;: [2, 3, 5, 26, 35, 12, 68, 37, 51],
 &#39;15&#39;: [22],
 &#39;22&#39;: [15],
 &#39;26&#39;: [2, 3, 5, 10, 35, 12, 68, 37, 51],
 &#39;35&#39;: [2, 3, 5, 10, 26, 12, 68, 37, 51],
 &#39;42&#39;: [43],
 &#39;46&#39;: [48],
 &#39;48&#39;: [46],
 &#39;55&#39;: [60],
 &#39;60&#39;: [55],
 &#39;65&#39;: [66],
 &#39;66&#39;: [65],
 &#39;70&#39;: [74],
 &#39;74&#39;: [70],
 &#39;12&#39;: [2, 3, 5, 10, 26, 35, 68, 37, 51],
 &#39;43&#39;: [42],
 &#39;53&#39;: [61],
 &#39;61&#39;: [53],
 &#39;68&#39;: [2, 3, 5, 10, 26, 35, 12, 37, 51],
 &#39;37&#39;: [2, 3, 5, 10, 26, 35, 12, 68, 51],
 &#39;51&#39;: [2, 3, 5, 10, 26, 35, 12, 68, 37]}
</pre></div></div>
</div>
<section id="Collect-branch-classifier-training-data">
<h2>Collect branch classifier training data<a class="headerlink" href="#Collect-branch-classifier-training-data" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">Training data consists of volumetric image patches chosen randomly from the neuron node coordinates given</div>
<div class="line">in the SWC file with an added small random translation. Image patches are labeled 1 if they are centered on</div>
<div class="line">a branch point and 0 otherwise.</div>
</div>
<section id="Get-sample-points-from-swc-files-then-save-sample-spherical-patches">
<h3>Get sample points from swc files then save sample spherical patches<a class="headerlink" href="#Get-sample-points-from-swc-files-then-save-sample-spherical-patches" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load SWC file data into python lists</span>
<span class="c1"># swc_dir = &quot;/nafs/dtward/bryson/gold166_swc_scaled&quot;</span>
<span class="c1"># swc_files = os.listdir(swc_dir)</span>
<span class="n">swc_dir</span> <span class="o">=</span> <span class="s2">&quot;/nafs/dtward/bryson/data/neuromorpho&quot;</span>
<span class="n">swc_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">swc_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*.swc&#39;</span><span class="p">))]</span>
<span class="n">swc_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">swc_files</span><span class="p">)</span>

<span class="c1"># img_dir = &quot;/nafs/dtward/bryson/gold166_tifs_scaled/&quot;</span>
<span class="c1"># img_files = os.listdir(img_dir)</span>
<span class="n">img_dir</span> <span class="o">=</span> <span class="s2">&quot;/nafs/dtward/bryson/data/simulated_neurons/neuromorpho_with_artifacts&quot;</span>
<span class="n">img_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*image.tif&#39;</span><span class="p">))]</span>
<span class="n">img_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">img_files</span><span class="p">)</span>

<span class="n">section_labels_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*sections.tif&#39;</span><span class="p">))]</span>
<span class="n">section_labels_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">section_labels_files</span><span class="p">)</span>

<span class="n">density_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*density.tif&#39;</span><span class="p">))]</span>
<span class="n">density_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">density_files</span><span class="p">)</span>

<span class="n">branch_mask_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*branches.tif&#39;</span><span class="p">))]</span>
<span class="n">branch_mask_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branch_mask_files</span><span class="p">)</span>

<span class="c1"># out_dir = os.path.expanduser(&quot;~/bmap/gold166_classifier_data/&quot;)</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/bmap/data/simulated_neurons/neuromorpho_branch_classifier_with_artifacts&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created directory: </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;observations&quot;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;observations&quot;</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
</section>
</section>
<section id="Test-branch-extraction-methods">
<h2>Test branch extraction methods<a class="headerlink" href="#Test-branch-extraction-methods" title="Link to this heading"></a></h2>
</section>
<section id="Acquire-large-square-patches-for-on-the-fly-patch-extraction">
<h2>Acquire large square patches for on-the-fly patch extraction<a class="headerlink" href="#Acquire-large-square-patches-for-on-the-fly-patch-extraction" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify one image</span>
<span class="c1"># img_file = img_files[4]</span>
<span class="n">swc_file</span> <span class="o">=</span> <span class="n">swc_files</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">img_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">img_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_image&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">swc_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
<span class="c1"># get its branches</span>
<span class="c1"># swc_file = [f for f in swc_files if f.split(&#39;/&#39;)[-1].split(&#39;.&#39;)[0] == img_file.split(&#39;/&#39;)[-1].split(&#39;_image&#39;)[0]][0]</span>
<span class="n">swc_list</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">swc</span><span class="p">(</span><span class="n">swc_file</span><span class="p">)</span>
<span class="n">sections</span><span class="p">,</span> <span class="n">section_graph</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">parse_swc</span><span class="p">(</span><span class="n">swc_list</span><span class="p">)</span>
<span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">get_critical_points</span><span class="p">(</span><span class="n">swc_list</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span><span class="c1">#, length_threshold=4.0)</span>
<span class="n">sections</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">adjust_neuron_coords</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/borst/CNG version/dHSN_02l.CNG.swc
removing 21 branches
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">branch_mask</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span><span class="o">+</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>
<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
    <span class="c1"># r = point[3].item() #/ xy_scale</span>
    <span class="n">branch_mask</span><span class="o">.</span><span class="n">draw_point</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize the image with branch mask</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">branch_mask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">branch_mask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">branch_mask</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f4843813820&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/branch_classifier_13_1.png" src="_images/branch_classifier_13_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># how many total branches are there?</span>
<span class="n">n_branches</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">swc_file</span> <span class="ow">in</span> <span class="n">swc_files</span><span class="p">[:</span><span class="mi">11</span><span class="p">]:</span>
    <span class="n">swc_list</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">swc</span><span class="p">(</span><span class="n">swc_file</span><span class="p">)</span>
    <span class="n">sections</span><span class="p">,</span> <span class="n">section_graph</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">parse_swc</span><span class="p">(</span><span class="n">swc_list</span><span class="p">)</span>
    <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">get_critical_points</span><span class="p">(</span><span class="n">swc_list</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>
    <span class="n">n_branches</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are a total of </span><span class="si">{</span><span class="n">n_branches</span><span class="o">*</span><span class="mi">2</span><span class="si">}</span><span class="s1"> branches.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/allen cell types/CNG version/646805498_transformed.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/baier/CNG version/150304_2_3_d.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/baier/CNG version/20160916_BGUG_HuC_ltRFP_d7_F13.CNG.swc
removing 3 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/beining/CNG version/35dpi_ipsi_infra_06.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/borst/CNG version/dHSN_02l.CNG.swc
removing 21 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/briggs/CNG version/Bub_9-13_c1.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/buskila/CNG version/MC-Aged-Cont-S2.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/buskila/CNG version/MC-Aged-cont-S1.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/buskila/CNG version/MC-Presymptomatic-SOD1-S3.CNG.swc
removing 0 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/buskila/CNG version/SSC-Aged-control-S13.CNG.swc
removing 1 branches
loading file: /nafs/dtward/bryson/data/neuromorpho/buskila/CNG version/SSC-Aged-control-S8.CNG.swc
removing 0 branches
There are a total of 1704 branches.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># create annotations</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">annotations_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="s1">&#39;neuromorpho&#39;</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">DATE</span><span class="si">}</span><span class="s2">_annotations.csv&quot;</span><span class="p">))</span>
<span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">annotations_</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Unnamed: 0&quot;</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="n">obs_id</span> <span class="o">=</span> <span class="mi">1704</span>
<span class="k">for</span> <span class="n">swc_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">swc_files</span><span class="p">[</span><span class="mi">11</span><span class="p">:],</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing SWC files&quot;</span><span class="p">):</span>
    <span class="n">swc_list</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">swc</span><span class="p">(</span><span class="n">swc_file</span><span class="p">)</span>
    <span class="n">sections</span><span class="p">,</span> <span class="n">section_graph</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">parse_swc</span><span class="p">(</span><span class="n">swc_list</span><span class="p">)</span>
    <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">get_critical_points</span><span class="p">(</span><span class="n">swc_list</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>
    <span class="n">sections</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">adjust_neuron_coords</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">terminals</span><span class="p">)</span>

    <span class="n">img_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">img_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_image&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">swc_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">branch</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s1">.tif&#39;</span>
        <span class="n">annotations</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">patch</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
        <span class="n">obs_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">section_id</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span><span class="o">%</span><span class="k">2</span>:

        <span class="n">point</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># Check if this point is far enough from any branch point</span>
        <span class="c1"># to avoid selecting branch points or points too close to branches</span>
        <span class="n">is_far_from_branches</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">branches</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">7.0</span><span class="p">:</span>  <span class="c1"># Minimum distance from branches</span>
            <span class="n">is_far_from_branches</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">is_far_from_branches</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Crop patch from image at this point</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s1">.tif&#39;</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">patch</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">obs_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="c1"># get len(branches)//2 non-neuron points</span>
    <span class="n">section_labels_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">section_labels_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_sections&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">swc_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">section_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">section_labels_file</span><span class="p">)</span>
    <span class="n">section_labels</span> <span class="o">=</span> <span class="n">section_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
        <span class="c1"># select a random point in the img</span>
        <span class="c1"># Get random coordinates within image dimensions</span>

        <span class="c1"># Generate random coordinates within image bounds</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">section_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">section_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">section_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Check if this point is outside neuron (section_labels == 0)</span>
        <span class="k">if</span> <span class="n">section_labels</span><span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>  <span class="c1"># Save as [z,y,x,r] format</span>

            <span class="c1"># Crop patch from image at this point</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s1">.tif&#39;</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">patch</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
            <span class="n">obs_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;neuromorpho&quot;</span>
<span class="n">data_permutation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">))</span>
<span class="n">test_idxs</span> <span class="o">=</span> <span class="n">data_permutation</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data_permutation</span><span class="p">)</span><span class="o">//</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">training_idxs</span> <span class="o">=</span> <span class="n">data_permutation</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data_permutation</span><span class="p">)</span><span class="o">//</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">training_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">training_idxs</span><span class="p">}</span>
<span class="n">test_annotations</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">test_idxs</span><span class="p">}</span>
<span class="c1"># save</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">training_annotations</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">DATE</span><span class="si">}</span><span class="s2">_training_labels.csv&quot;</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">test_annotations</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">DATE</span><span class="si">}</span><span class="s2">_test_labels.csv&quot;</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   0%|          | 0/64 [00:00&lt;?, ?it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/campos/CNG version/Astro-1.CNG.swc
removing 1 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   2%|▏         | 1/64 [00:05&lt;05:44,  5.46s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/castanho_oliveira/CNG version/13_L3_C3_N5.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   3%|▎         | 2/64 [00:20&lt;11:38, 11.27s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/charlet/CNG version/CeA_Astrocyte_12_003.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   5%|▍         | 3/64 [00:43&lt;16:34, 16.30s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/charlet/CNG version/CeA_Astrocyte_3_021.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   6%|▋         | 4/64 [01:04&lt;18:16, 18.28s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/chiang/CNG version/Cha-F-000302.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   8%|▊         | 5/64 [01:31&lt;21:13, 21.59s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/chiang/CNG version/Cha-F-600090.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:   9%|▉         | 6/64 [01:59&lt;22:44, 23.53s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/defelipe/CNG version/M1KO_15.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  11%|█         | 7/64 [02:20&lt;21:46, 22.92s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/denizet/CNG version/cort4c4pg1d.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  12%|█▎        | 8/64 [02:46&lt;22:18, 23.90s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/denk/CNG version/orphan_3807.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  14%|█▍        | 9/64 [03:13&lt;22:37, 24.69s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/dierssen/CNG version/WT_6mo_3_11.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  16%|█▌        | 10/64 [03:36&lt;21:45, 24.18s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/diniz/CNG version/C13_1-6_80um_GFAP_Z-fixed0102_08-April16_C47.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  17%|█▋        | 11/64 [04:00&lt;21:25, 24.26s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/eyewire/CNG version/skel_20220_sorted.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  19%|█▉        | 12/64 [05:28&lt;37:50, 43.66s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/flyem/CNG version/KC-p-5303804.CNG.swc
removing 2 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  20%|██        | 13/64 [06:04&lt;35:02, 41.23s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/gaspar/CNG version/1-CTR_2w_Female_Nac_6.CNG.swc
removing 7 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  22%|██▏       | 14/64 [06:30&lt;30:40, 36.81s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/gaspar/CNG version/12-DEX-STRESS_male_Nac_7.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  23%|██▎       | 15/64 [06:37&lt;22:34, 27.63s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/gaspar/CNG version/8-STRESS_2w_Female_HIP_7.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  25%|██▌       | 16/64 [06:57&lt;20:23, 25.48s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/giniger/CNG version/ABL-OE-14--ims.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  27%|██▋       | 17/64 [07:21&lt;19:38, 25.08s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/guizzetti/CNG version/P3_CV3_79.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  28%|██▊       | 18/64 [07:42&lt;18:04, 23.58s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/hamad/CNG version/pcs74_8.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  30%|██▉       | 19/64 [08:03&lt;17:18, 23.08s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/hart/CNG version/2016-10-27_541_mir-1_day_3_3.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  31%|███▏      | 20/64 [08:24&lt;16:23, 22.35s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/hart/CNG version/2016-10-27_541_mir-1_day_3_5.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  33%|███▎      | 21/64 [08:49&lt;16:39, 23.24s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/hosseini/CNG version/Aged_mice_VAC-PBS10_58-DG-1.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  34%|███▍      | 22/64 [09:13&lt;16:25, 23.46s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/jacobs/CNG version/194-2-6lw.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  36%|███▌      | 23/64 [09:42&lt;17:06, 25.04s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/jefferis/CNG version/NNE1L.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  38%|███▊      | 24/64 [10:06&lt;16:31, 24.79s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/jongbloets/CNG version/14dpi_WT2_S6_2.CNG.swc
removing 1 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  39%|███▉      | 25/64 [10:23&lt;14:27, 22.25s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/kuddannaya/CNG version/Tracetest_N360_semicircle_Map2Tau_79_semi-auto_18.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  41%|████      | 26/64 [10:42&lt;13:30, 21.33s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/la barbera/CNG version/1-4_14.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  42%|████▏     | 27/64 [10:58&lt;12:08, 19.68s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/laBarbera_mercuri/CNG Version/1-4_14.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  44%|████▍     | 28/64 [11:02&lt;09:00, 15.02s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/luikart/CNG version/C29421-A4-60DPI-TDA-I1-CreCell-3.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  45%|████▌     | 29/64 [11:17&lt;08:44, 14.98s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/macdonald/CNG version/SD3.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  47%|████▋     | 30/64 [11:34&lt;08:53, 15.69s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/mehder/CNG version/Rasha-CA1-Exp-April-2016-right-slide-55-secion-1.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  48%|████▊     | 31/64 [11:47&lt;08:05, 14.71s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/nishitoh/CNG version/D2_C_22.CNG.swc
removing 4 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  50%|█████     | 32/64 [12:02&lt;08:01, 15.06s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/prichard_singer/CNG version/MsJinx16_NoFlicker_1h_IBA1_NFkBinh_17.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  52%|█████▏    | 33/64 [12:25&lt;08:56, 17.30s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/quinlan/CNG version/KQa4-12-2015-tracing.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  53%|█████▎    | 34/64 [12:49&lt;09:44, 19.49s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/roysam/CNG version/farsight879.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  55%|█████▍    | 35/64 [13:11&lt;09:45, 20.18s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/CN_Development_P15_F_Animal01_Trace040.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  56%|█████▋    | 36/64 [13:30&lt;09:11, 19.69s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/CN_Development_P22_F_Animal03_Trace009.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  58%|█████▊    | 37/64 [13:50&lt;08:57, 19.91s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/CN_Development_P22_M_Animal03_Trace047.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  59%|█████▉    | 38/64 [14:13&lt;09:03, 20.89s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/DG_5xFAD_3mpos_F_Animal02_Trace178.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  61%|██████    | 39/64 [14:31&lt;08:15, 19.83s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/DG_5xFAD_6mpos_M_Animal03_Trace080.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  62%|██████▎   | 40/64 [14:48&lt;07:33, 18.91s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/DG_Adulthood_Control_F_Animal01_Trace891.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  64%|██████▍   | 41/64 [15:19&lt;08:41, 22.66s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/DG_CKp25_2w_M_Animal01_Trace048.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  66%|██████▌   | 42/64 [15:40&lt;08:08, 22.19s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/DG_Development_P22_M_Animal03_Trace060.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  67%|██████▋   | 43/64 [16:01&lt;07:40, 21.94s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/FC_Adulthood_Control_M_Animal01_Trace036.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  69%|██████▉   | 44/64 [16:26&lt;07:33, 22.66s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/FC_Development_P15_M_Animal02_Trace109.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  70%|███████   | 45/64 [16:52&lt;07:32, 23.79s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/FC_Development_P22_F_Animal03_Trace164.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  72%|███████▏  | 46/64 [17:23&lt;07:47, 25.97s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/OB_Adulthood_Control_F_Animal04_Trace056.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  73%|███████▎  | 47/64 [17:47&lt;07:07, 25.18s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_5xFAD_3mpos_M_Animal03_Trace037.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  75%|███████▌  | 48/64 [18:12&lt;06:42, 25.17s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_5xFAD_6mpos_F_Animal03_Trace003.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  77%|███████▋  | 49/64 [18:36&lt;06:11, 24.79s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_CKp25_1w_M_Animal02_Trace067.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  78%|███████▊  | 50/64 [18:59&lt;05:41, 24.39s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_CKp25_6w_F_Animal02_Trace063.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  80%|███████▉  | 51/64 [19:28&lt;05:36, 25.85s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_CKp25_6w_M_Animal04_Trace008.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  81%|████████▏ | 52/64 [19:56&lt;05:16, 26.36s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/S1_Ovariectomy_Animal01_Trace032.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  83%|████████▎ | 53/64 [20:28&lt;05:10, 28.19s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/SN_5xFAD_6mpos_M_Animal03_Trace033.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  84%|████████▍ | 54/64 [20:49&lt;04:20, 26.04s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/SN_Adulthood_Control_M_Animal08_Trace005.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  86%|████████▌ | 55/64 [21:18&lt;04:01, 26.83s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/CNG version/SN_Ovariectomy_Animal02_Trace052.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  88%|████████▊ | 56/64 [21:42&lt;03:27, 25.95s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/siegert/Source-Version/OB_Adulthood_Control_F_Animal04_Trace056.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [136.434  84.564 404.52 ] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [134.313  85.32  414.264] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [141.663  55.941 464.951] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [167.059  41.563 481.401] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [187.842  95.449 397.359] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [144.365 257.331 438.092] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [153.276  70.991 512.348] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
/home/bgray/neurotrack/notebooks/../data_prep/image.py:194: UserWarning: Center [125.402  93.636 436.545] is out of bounds for image shape torch.Size([235, 536, 396]). Translating to the nearest valid index.
  warnings.warn(f&#34;Center {center} is out of bounds for image shape {shape}. Translating to the nearest valid index.&#34;)
Processing SWC files:  89%|████████▉ | 57/64 [21:50&lt;02:23, 20.52s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/steelman/CNG version/gw-4-image-3_22.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  91%|█████████ | 58/64 [22:08&lt;01:58, 19.76s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/tenner/CNG version/7month-Arctic-C5aR1-KO-11_2.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  92%|█████████▏| 59/64 [22:21&lt;01:28, 17.72s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/todd/CNG version/C242-01-08-14-B1.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  94%|█████████▍| 60/64 [22:46&lt;01:19, 19.88s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/tolias/CNG version/L5MC-J130731a.CNG.swc
removing 1 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  95%|█████████▌| 61/64 [23:38&lt;01:28, 29.58s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/wong/CNG version/L100P-GSK3-Het-9.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  97%|█████████▋| 62/64 [23:52&lt;00:49, 24.98s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/yayon_soreq/CNG version/Cell_134_MPD_12_FT_10_XYZ_Sorted-swc_N3DFix-swc_4.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files:  98%|█████████▊| 63/64 [24:10&lt;00:22, 22.92s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
loading file: /nafs/dtward/bryson/data/neuromorpho/yayon_soreq/CNG version/Cell_528_MPD_8_FT_10_XYZ_Sorted-swc_N3DFix-swc_1.CNG.swc
removing 0 branches
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Processing SWC files: 100%|██████████| 64/64 [24:25&lt;00:00, 22.90s/it]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="s1">&#39;neuromorpho&#39;</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">DATE</span><span class="si">}</span><span class="s2">_annotations.csv&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Test-spherical-patch-extraction">
<h2>Test spherical patch extraction<a class="headerlink" href="#Test-spherical-patch-extraction" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">img_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span><span class="n">img</span><span class="p">))</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">branch_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">//</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">])]</span>
<span class="n">permutations</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
<span class="c1"># Create meshgrid for spherical coordinates</span>
<span class="n">theta_res</span><span class="p">,</span> <span class="n">phi_res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">360</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">theta_res</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">phi_res</span><span class="p">)</span>
<span class="n">theta_grid</span><span class="p">,</span> <span class="n">phi_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

<span class="c1"># Convert to cartesian coordinates (points on a unit sphere)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample branch positive patches</span>
<span class="k">with</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span> <span class="k">as</span> <span class="n">pr</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_coords</span><span class="p">)):</span>
        <span class="n">spherical_patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">extract_spherical_patch</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">branch_coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">permutation</span><span class="o">=</span><span class="n">perm</span><span class="p">)</span>
                <span class="n">spherical_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">spherical_patches</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
         5099 function calls (5098 primitive calls) in 0.574 seconds

   Ordered by: cumulative time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
      108    0.026    0.000    0.562    0.005 /home/bgray/neurotrack/notebooks/../data_prep/image.py:74(extract_spherical_patch)
      108    0.001    0.000    0.503    0.005 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_interpolation.py:358(map_coordinates)
      108    0.497    0.005    0.497    0.005 {built-in method scipy.ndimage._nd_image.geometric_transform}
      108    0.032    0.000    0.032    0.000 {built-in method numpy.array}
  326/325    0.012    0.000    0.013    0.000 {built-in method numpy.core._multiarray_umath.implement_array_function}
        1    0.000    0.000    0.012    0.012 &lt;__array_function__ internals&gt;:2(stack)
        1    0.000    0.000    0.012    0.012 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:357(stack)
        1    0.000    0.000    0.012    0.012 &lt;__array_function__ internals&gt;:2(concatenate)
      108    0.001    0.000    0.004    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_ni_support.py:73(_get_output)
      108    0.002    0.000    0.002    0.000 {built-in method numpy.zeros}
      108    0.000    0.000    0.001    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:321(_name_get)
      216    0.000    0.000    0.001    0.000 &lt;__array_function__ internals&gt;:2(iscomplexobj)
      108    0.000    0.000    0.001    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:307(_name_includes_bit_suffix)
      108    0.000    0.000    0.001    0.000 &lt;__array_function__ internals&gt;:2(transpose)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/numerictypes.py:358(issubdtype)
      324    0.000    0.000    0.000    0.000 {method &#39;item&#39; of &#39;numpy.generic&#39; objects}
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:601(transpose)
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/numerictypes.py:284(issubclass_)
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/lib/type_check.py:303(iscomplexobj)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:51(_wrapfunc)
      648    0.000    0.000    0.000    0.000 {built-in method builtins.issubclass}
      108    0.000    0.000    0.000    0.000 {method &#39;reshape&#39; of &#39;numpy.ndarray&#39; objects}
      108    0.000    0.000    0.000    0.000 {method &#39;format&#39; of &#39;str&#39; objects}
      108    0.000    0.000    0.000    0.000 {method &#39;transpose&#39; of &#39;numpy.ndarray&#39; objects}
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:24(_kind_name)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_ni_support.py:36(_extend_mode_to_code)
      432    0.000    0.000    0.000    0.000 {method &#39;append&#39; of &#39;list&#39; objects}
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/lib/type_check.py:206(_is_type_dispatcher)
      108    0.000    0.000    0.000    0.000 {built-in method builtins.getattr}
      216    0.000    0.000    0.000    0.000 {built-in method numpy.asarray}
      111    0.000    0.000    0.000    0.000 {built-in method builtins.len}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:89(__init__)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:432(&lt;listcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:99(init)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:597(_transpose_dispatcher)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:424(&lt;setcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:420(&lt;listcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:118(load_stats)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:348(_stack_dispatcher)
      108    0.000    0.000    0.000    0.000 {built-in method numpy.asanyarray}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:207(_arrays_for_stack_dispatcher)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/cProfile.py:51(create_stats)
        2    0.000    0.000    0.000    0.000 {built-in method builtins.hasattr}
        1    0.000    0.000    0.000    0.000 {built-in method builtins.isinstance}
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
        1    0.000    0.000    0.000    0.000 {built-in method numpy.core._multiarray_umath.normalize_axis_index}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/multiarray.py:148(concatenate)


         5099 function calls (5098 primitive calls) in 0.574 seconds

   Ordered by: cumulative time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
      108    0.026    0.000    0.562    0.005 /home/bgray/neurotrack/notebooks/../data_prep/image.py:74(extract_spherical_patch)
      108    0.001    0.000    0.503    0.005 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_interpolation.py:358(map_coordinates)
      108    0.497    0.005    0.497    0.005 {built-in method scipy.ndimage._nd_image.geometric_transform}
      108    0.032    0.000    0.032    0.000 {built-in method numpy.array}
  326/325    0.012    0.000    0.013    0.000 {built-in method numpy.core._multiarray_umath.implement_array_function}
        1    0.000    0.000    0.012    0.012 &lt;__array_function__ internals&gt;:2(stack)
        1    0.000    0.000    0.012    0.012 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:357(stack)
        1    0.000    0.000    0.012    0.012 &lt;__array_function__ internals&gt;:2(concatenate)
      108    0.001    0.000    0.004    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_ni_support.py:73(_get_output)
      108    0.002    0.000    0.002    0.000 {built-in method numpy.zeros}
      108    0.000    0.000    0.001    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:321(_name_get)
      216    0.000    0.000    0.001    0.000 &lt;__array_function__ internals&gt;:2(iscomplexobj)
      108    0.000    0.000    0.001    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:307(_name_includes_bit_suffix)
      108    0.000    0.000    0.001    0.000 &lt;__array_function__ internals&gt;:2(transpose)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/numerictypes.py:358(issubdtype)
      324    0.000    0.000    0.000    0.000 {method &#39;item&#39; of &#39;numpy.generic&#39; objects}
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:601(transpose)
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/numerictypes.py:284(issubclass_)
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/lib/type_check.py:303(iscomplexobj)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:51(_wrapfunc)
      648    0.000    0.000    0.000    0.000 {built-in method builtins.issubclass}
      108    0.000    0.000    0.000    0.000 {method &#39;reshape&#39; of &#39;numpy.ndarray&#39; objects}
      108    0.000    0.000    0.000    0.000 {method &#39;format&#39; of &#39;str&#39; objects}
      108    0.000    0.000    0.000    0.000 {method &#39;transpose&#39; of &#39;numpy.ndarray&#39; objects}
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/_dtype.py:24(_kind_name)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/scipy/ndimage/_ni_support.py:36(_extend_mode_to_code)
      432    0.000    0.000    0.000    0.000 {method &#39;append&#39; of &#39;list&#39; objects}
      216    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/lib/type_check.py:206(_is_type_dispatcher)
      108    0.000    0.000    0.000    0.000 {built-in method builtins.getattr}
      216    0.000    0.000    0.000    0.000 {built-in method numpy.asarray}
      111    0.000    0.000    0.000    0.000 {built-in method builtins.len}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:89(__init__)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:432(&lt;listcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:99(init)
      108    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/fromnumeric.py:597(_transpose_dispatcher)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:424(&lt;setcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:420(&lt;listcomp&gt;)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/pstats.py:118(load_stats)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:348(_stack_dispatcher)
      108    0.000    0.000    0.000    0.000 {built-in method numpy.asanyarray}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/shape_base.py:207(_arrays_for_stack_dispatcher)
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/cProfile.py:51(create_stats)
        2    0.000    0.000    0.000    0.000 {built-in method builtins.hasattr}
        1    0.000    0.000    0.000    0.000 {built-in method builtins.isinstance}
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
        1    0.000    0.000    0.000    0.000 {built-in method numpy.core._multiarray_umath.normalize_axis_index}
        1    0.000    0.000    0.000    0.000 /home/bgray/anaconda3/envs/neurotrack/lib/python3.8/site-packages/numpy/core/multiarray.py:148(concatenate)


</pre></div></div>
</div>
</section>
<section id="Collect-branch-patch-data">
<h2>Collect branch patch data<a class="headerlink" href="#Collect-branch-patch-data" title="Link to this heading"></a></h2>
</section>
<section id="save-coordinates-and-annotations">
<h2>save coordinates and annotations<a class="headerlink" href="#save-coordinates-and-annotations" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collect</span><span class="o">.</span><span class="n">save_coordinates_and_annotations</span><span class="p">(</span><span class="n">swc_dir</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">samples_per_neuron</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">branch_radius_filter</span><span class="o">=</span><span class="mf">15.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  1%|          | 1/132 [03:16&lt;7:09:07, 196.55s/it]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[25], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">collect</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">save_coordinates_and_annotations</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">swc_dir</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">img_dir</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">out_dir</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">samples_per_neuron</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">100</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">seed</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">0</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">branch_radius_filter</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">15.0</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/neurotrack/notebooks/../data_prep/collect.py:279</span>, in <span class="ansi-cyan-fg">save_coordinates_and_annotations</span><span class="ansi-blue-fg">(swc_dir, img_dir, out_dir, samples_per_neuron, seed, branch_radius_filter)</span>
<span class="ansi-green-intense-fg ansi-bold">    277</span> current_size <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">len</span>(annotations)
<span class="ansi-green-intense-fg ansi-bold">    278</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> i <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> <span style="color: rgb(0,135,0)">range</span>(current_size, current_size <span style="color: rgb(98,98,98)">+</span> <span style="color: rgb(0,135,0)">len</span>(sample_points)<span style="color: rgb(98,98,98)">*</span>samples_per_neuron):
<span class="ansi-green-fg">--&gt; 279</span>     k <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">i</span> <span style="color: rgb(98,98,98)">-</span> current_size <span style="color: rgb(98,98,98)">&lt;</span> <span style="color: rgb(0,135,0)">len</span>(branch_coords)
<span class="ansi-green-intense-fg ansi-bold">    280</span>     annotations[<span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">obs_</span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>i<span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)">.tif</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">=</span> k
<span class="ansi-green-intense-fg ansi-bold">    282</span> <span style="color: rgb(95,135,135)"># # overwrite sample points and annotations after every file</span>
<span class="ansi-green-intense-fg ansi-bold">    283</span> <span style="color: rgb(95,135,135)"># np.save(os.path.join(out_dir, f&#34;sample_points_{date}.npy&#34;), sample_points)</span>
<span class="ansi-green-intense-fg ansi-bold">    284</span> <span style="color: rgb(95,135,135)"># # save annotations</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-intense-fg ansi-bold">    295</span> <span style="color: rgb(95,135,135)"># df = pd.DataFrame.from_dict(test_annotations, orient=&#34;index&#34;)</span>
<span class="ansi-green-intense-fg ansi-bold">    296</span> <span style="color: rgb(95,135,135)"># df.to_csv(os.path.join(out_dir, f&#34;branch_classifier_{name}_{date}_test_labels.csv&#34;))</span>

File <span class="ansi-green-fg">~/neurotrack/notebooks/../data_prep/collect.py:279</span>, in <span class="ansi-cyan-fg">save_coordinates_and_annotations</span><span class="ansi-blue-fg">(swc_dir, img_dir, out_dir, samples_per_neuron, seed, branch_radius_filter)</span>
<span class="ansi-green-intense-fg ansi-bold">    277</span> current_size <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">len</span>(annotations)
<span class="ansi-green-intense-fg ansi-bold">    278</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> i <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> <span style="color: rgb(0,135,0)">range</span>(current_size, current_size <span style="color: rgb(98,98,98)">+</span> <span style="color: rgb(0,135,0)">len</span>(sample_points)<span style="color: rgb(98,98,98)">*</span>samples_per_neuron):
<span class="ansi-green-fg">--&gt; 279</span>     k <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">i</span> <span style="color: rgb(98,98,98)">-</span> current_size <span style="color: rgb(98,98,98)">&lt;</span> <span style="color: rgb(0,135,0)">len</span>(branch_coords)
<span class="ansi-green-intense-fg ansi-bold">    280</span>     annotations[<span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">obs_</span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>i<span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)">.tif</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">=</span> k
<span class="ansi-green-intense-fg ansi-bold">    282</span> <span style="color: rgb(95,135,135)"># # overwrite sample points and annotations after every file</span>
<span class="ansi-green-intense-fg ansi-bold">    283</span> <span style="color: rgb(95,135,135)"># np.save(os.path.join(out_dir, f&#34;sample_points_{date}.npy&#34;), sample_points)</span>
<span class="ansi-green-intense-fg ansi-bold">    284</span> <span style="color: rgb(95,135,135)"># # save annotations</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-intense-fg ansi-bold">    295</span> <span style="color: rgb(95,135,135)"># df = pd.DataFrame.from_dict(test_annotations, orient=&#34;index&#34;)</span>
<span class="ansi-green-intense-fg ansi-bold">    296</span> <span style="color: rgb(95,135,135)"># df.to_csv(os.path.join(out_dir, f&#34;branch_classifier_{name}_{date}_test_labels.csv&#34;))</span>

File <span class="ansi-green-fg">_pydevd_bundle/pydevd_cython.pyx:1457</span>, in <span class="ansi-cyan-fg">_pydevd_bundle.pydevd_cython.SafeCallWrapper.__call__</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">_pydevd_bundle/pydevd_cython.pyx:701</span>, in <span class="ansi-cyan-fg">_pydevd_bundle.pydevd_cython.PyDBFrame.trace_dispatch</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">_pydevd_bundle/pydevd_cython.pyx:1395</span>, in <span class="ansi-cyan-fg">_pydevd_bundle.pydevd_cython.PyDBFrame.trace_dispatch</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">_pydevd_bundle/pydevd_cython.pyx:1344</span>, in <span class="ansi-cyan-fg">_pydevd_bundle.pydevd_cython.PyDBFrame.trace_dispatch</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">_pydevd_bundle/pydevd_cython.pyx:312</span>, in <span class="ansi-cyan-fg">_pydevd_bundle.pydevd_cython.PyDBFrame.do_wait_suspend</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">~/anaconda3/envs/neurotrack/lib/python3.8/site-packages/debugpy/_vendored/pydevd/pydevd.py:2070</span>, in <span class="ansi-cyan-fg">PyDB.do_wait_suspend</span><span class="ansi-blue-fg">(self, thread, frame, event, arg, exception_type)</span>
<span class="ansi-green-intense-fg ansi-bold">   2067</span>             from_this_thread<span style="color: rgb(98,98,98)">.</span>append(frame_custom_thread_id)
<span class="ansi-green-intense-fg ansi-bold">   2069</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">with</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>_threads_suspended_single_notification<span style="color: rgb(98,98,98)">.</span>notify_thread_suspended(thread_id, thread, stop_reason):
<span class="ansi-green-fg">-&gt; 2070</span>         keep_suspended <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">_do_wait_suspend</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">thread</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">frame</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">event</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">arg</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">suspend_type</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">from_this_thread</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">frames_tracker</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2072</span> frames_list <span style="color: rgb(98,98,98)">=</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>
<span class="ansi-green-intense-fg ansi-bold">   2074</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> keep_suspended:
<span class="ansi-green-intense-fg ansi-bold">   2075</span>     <span style="color: rgb(95,135,135)"># This means that we should pause again after a set next statement.</span>

File <span class="ansi-green-fg">~/anaconda3/envs/neurotrack/lib/python3.8/site-packages/debugpy/_vendored/pydevd/pydevd.py:2106</span>, in <span class="ansi-cyan-fg">PyDB._do_wait_suspend</span><span class="ansi-blue-fg">(self, thread, frame, event, arg, suspend_type, from_this_thread, frames_tracker)</span>
<span class="ansi-green-intense-fg ansi-bold">   2103</span>         <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>_call_input_hook()
<span class="ansi-green-intense-fg ansi-bold">   2105</span>     <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>process_internal_commands()
<span class="ansi-green-fg">-&gt; 2106</span>     <span class="ansi-yellow-bg">time</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">sleep</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">0.01</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2108</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>cancel_async_evaluation(get_current_thread_id(thread), <span style="color: rgb(0,135,0)">str</span>(<span style="color: rgb(0,135,0)">id</span>(frame)))
<span class="ansi-green-intense-fg ansi-bold">   2110</span> <span style="color: rgb(95,135,135)"># process any stepping instructions</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>:
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visually check sample of branch points</span>
<span class="n">sample_points_path</span> <span class="o">=</span> <span class="s2">&quot;/nafs/dtward/bryson/gold166_classifier_data/sample_points_03-26-25.npy&quot;</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sample_points_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">sample_points</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="c1"># get a branch point</span>
<span class="n">fname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sample_points</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opening: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">sample_points</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Opening: 080926a.tif
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
<span class="c1"># branch points</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[:</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="c1"># non-branch points</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="mi">50</span><span class="p">:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7fc000e56e80&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/branch_classifier_24_1.png" src="_images/branch_classifier_24_1.png" />
</div>
</div>
</section>
<section id="save-square-patches">
<h2>save square patches<a class="headerlink" href="#save-square-patches" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_dir</span> <span class="o">=</span> <span class="s2">&quot;/nafs/dtward/bryson/gold166_tifs_scaled/&quot;</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/bmap/gold166_classifier_data/&quot;</span><span class="p">)</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/nafs/dtward/bryson/gold166_classifier_data/sample_points_03-26-25.npy&quot;</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">sample_points</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">collect</span><span class="o">.</span><span class="n">save_square_patches</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  0%|          | 0/132 [00:00&lt;?, ?it/s]100%|██████████| 132/132 [09:54&lt;00:00,  4.51s/it]
</pre></div></div>
</div>
</section>
<section id="save-spherical-patches">
<h2>save spherical patches<a class="headerlink" href="#save-spherical-patches" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/bgray/data/gold166_classifier_data&quot;</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/nafs/dtward/bryson/gold166_classifier_data/sample_points_03-26-25.npy&quot;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_points</span> <span class="o">=</span> <span class="n">sample_points</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="n">radii</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">collect</span><span class="o">.</span><span class="n">save_spherical_patches</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">img_dir</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 132/132 [53:59&lt;00:00, 24.54s/it]
</pre></div></div>
</div>
<section id="View-some-example-input-images">
<h3>View some example input images<a class="headerlink" href="#View-some-example-input-images" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># observations = os.listdir(os.path.join(out_dir, &quot;observations&quot;))</span>
<span class="c1"># training_annotations = pd.read_csv(glob(os.path.join(out_dir, &quot;*_labels.csv&quot;))[0])</span>
<span class="c1"># ids = np.random.choice(len(training_annotations), size=9)</span>
<span class="c1"># sample = training_annotations.iloc[ids]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="s2">&quot;observations&quot;</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># shell = 0</span>
    <span class="c1"># shell = 6</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># type: ignore</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">shell</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;label: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/branch_classifier_30_0.png" src="_images/branch_classifier_30_0.png" />
</div>
</div>
</section>
</section>
<section id="Train-branch-classifier">
<h2>Train branch classifier<a class="headerlink" href="#Train-branch-classifier" title="Link to this heading"></a></h2>
<section id="Instantiate-dataloader-for-training-and-test-datasets">
<h3>Instantiate dataloader for training and test datasets<a class="headerlink" href="#Instantiate-dataloader-for-training-and-test-datasets" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Dataloaders use a weighted random sampler to balance classes. Additionally, the training dataset</div>
<div class="line">adds a random permutation and flip to the image patch at retrieval.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set source data files paths</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;neuromorpho&quot;</span>
<span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;04-02-25&quot;</span>

<span class="n">training_labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">_training_labels.csv&quot;</span><span class="p">)</span>
<span class="n">test_labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;branch_classifier_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">_test_labels.csv&quot;</span><span class="p">)</span>
<span class="n">img_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;observations&quot;</span><span class="p">)</span>
<span class="c1"># img_dir = os.path.join(out_dir, f&quot;observations&quot;)</span>

<span class="c1"># instantiate training and test datasets</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">transform</span> <span class="c1"># random permutation and flip</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">StateData</span><span class="p">(</span><span class="n">labels_file</span><span class="o">=</span><span class="n">training_labels_file</span><span class="p">,</span> <span class="n">img_dir</span><span class="o">=</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">StateData</span><span class="p">(</span><span class="n">labels_file</span><span class="o">=</span><span class="n">test_labels_file</span><span class="p">,</span> <span class="n">img_dir</span><span class="o">=</span><span class="n">img_dir</span><span class="p">)</span>

<span class="c1"># instantiate dataloaders</span>
<span class="n">batchsize</span><span class="o">=</span><span class="mi">50</span>
<span class="n">training_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">)</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batchsize</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># out_dir = os.path.expanduser(&quot;~/bmap/gold166_classifier_data/&quot;)</span>
<span class="n">weights_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;classifier_weights/&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># classifier = models.ResNet2D(models.ResidualBlock2D, [3, 4, 6, 3], in_channels=54, num_classes=1)</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ResNet3D</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ResidualBlock3D</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="n">branch_classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_dataloader</span><span class="p">,</span> <span class="n">test_dataloader</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">weights_out</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">classifier</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span> <span class="n">state_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Save-sample-patches-and-labels-from-image-files">
<h3>Save sample patches and labels from image files<a class="headerlink" href="#Save-sample-patches-and-labels-from-image-files" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save sample patches from the images centered at the sample points</span>
<span class="c1"># image_dir = &quot;/home/brysongray/data/simulated_neurons/neuromorpho_sub1_with_artifacts&quot;</span>
<span class="n">image_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/brysongray/&quot;</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="s2">&quot;classifier_data&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;neuromorpho_test&quot;</span>

<span class="n">collect</span><span class="o">.</span><span class="n">collect_data</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="id1">
<h3>View some example input images<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">out_dir</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;/home/bgray/bmap/data/simulated_neurons/neuromorpho_branch_classifier_with_artifacts&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observations_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;observations&quot;</span><span class="p">)</span>
<span class="n">training_annotations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;*04-02-25_training_labels.csv&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_annotations</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">sample</span> <span class="o">=</span> <span class="n">training_annotations</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)):</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observations_dir</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="c1">#, vmax=1.0, vmin=0.0)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;label: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/branch_classifier_39_0.png" src="_images/branch_classifier_39_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># look at each patch with orthogonal views</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">54</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)):</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observations_dir</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="c1">#, vmax=1.0, vmin=0.0)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="c1">#, vmax=1.0, vmin=0.0)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="c1">#, vmax=1.0, vmin=0.0)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;label: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="c1"># ax[i].set_title(f&quot;label: {sample.iloc[i,1].item()}&quot;)</span>
    <span class="c1"># ax[i].set_axis_off()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/branch_classifier_40_0.png" src="_images/branch_classifier_40_0.png" />
</div>
</div>
</section>
</section>
<section id="id2">
<h2>Train branch classifier<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="id3">
<h3>Instantiate dataloader for training and test datasets<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Dataloaders use a weighted random sampler to balance classes. Additionally, the training dataset</div>
<div class="line">adds a random permutation and flip to the image patch at retrieval.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set source data files paths</span>
<span class="n">training_labels_file</span> <span class="o">=</span> <span class="s2">&quot;classifier_data/branch_classifier_neuromorpho_test_02-07-25_test_labels.csv&quot;</span>
<span class="n">test_labels_file</span> <span class="o">=</span> <span class="s2">&quot;classifier_data/branch_classifier_neuromorpho_test_02-07-25_training_labels.csv&quot;</span>
<span class="n">img_dir</span> <span class="o">=</span> <span class="s2">&quot;classifier_data/observations&quot;</span>

<span class="c1"># instantiate training and test datasets</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">transform</span> <span class="c1"># random permutation and flip</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">StateData</span><span class="p">(</span><span class="n">labels_file</span><span class="o">=</span><span class="n">training_labels_file</span><span class="p">,</span>
                          <span class="n">img_dir</span><span class="o">=</span><span class="n">img_dir</span><span class="p">,</span>
                          <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">StateData</span><span class="p">(</span><span class="n">labels_file</span><span class="o">=</span><span class="n">test_labels_file</span><span class="p">,</span>
                          <span class="n">img_dir</span><span class="o">=</span><span class="n">img_dir</span><span class="p">)</span>

<span class="c1"># instantiate dataloaders</span>
<span class="n">training_dataloader</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">init_dataloader</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">branch_classifier</span><span class="o">.</span><span class="n">init_dataloader</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="View-balanced-data">
<h2>View balanced data<a class="headerlink" href="#View-balanced-data" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="make_simulated_neurons.html" class="btn btn-neutral float-left" title="Make Simulated Neurons" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sac_tracking_inference.html" class="btn btn-neutral float-right" title="Tracking Inference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Bryson Gray, Daniel Tward.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>